name: Test

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: test-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  core-tests:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck core
        run: cd packages/core && bun run typecheck

      - name: Test core
        run: cd packages/core && bun test

  detect-changed-apps:
    runs-on: self-hosted
    outputs:
      apps: ${{ steps.filter.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed apps
        id: filter
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          ALL_APPS=(
            api-coder
            architect-agent
            argocd-deployer
            auth-service
            claude-mqtt-bridge
            context-service
            cost-tracker
            dashboard
            event-logger
            homelab-monitor
            implementer
            infra-manager
            kubectl-deployer
            llm-service
            onboarding-service
            orchestrator
            project-manager
            qa-tester
            researcher-agent
            simple-agent
            ui-agent
            webhook-receiver
          )

          APPS=()
          for app in "${ALL_APPS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^apps/${app}/"; then
              APPS+=("$app")
            fi
          done

          # If core changed, typecheck all apps
          if echo "$CHANGED_FILES" | grep -q '^packages/core/'; then
            APPS=("${ALL_APPS[@]}")
          fi

          UNIQUE_APPS=($(echo "${APPS[@]}" | tr ' ' '\n' | sort -u))

          if [ ${#UNIQUE_APPS[@]} -eq 0 ]; then
            echo 'apps=[]' >> "$GITHUB_OUTPUT"
          else
            JSON=$(printf '%s\n' "${UNIQUE_APPS[@]}" | jq -R . | jq -sc .)
            echo "apps=$JSON" >> "$GITHUB_OUTPUT"
          fi

  typecheck-apps:
    needs: detect-changed-apps
    if: ${{ needs.detect-changed-apps.outputs.apps != '[]' }}
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changed-apps.outputs.apps) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck ${{ matrix.app }}
        run: cd apps/${{ matrix.app }} && bun run typecheck

  e2e-tests:
    if: github.event_name == 'workflow_dispatch'
    runs-on: [self-hosted, k3s-runner]
    timeout-minutes: 180
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TEST_PROJECT_ID: ${{ secrets.TEST_PROJECT_ID }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      TEST_APP_URL: ${{ secrets.TEST_APP_URL }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run E2E tests
        run: bun test tests/e2e/full-lifecycle.test.ts --timeout 600000
