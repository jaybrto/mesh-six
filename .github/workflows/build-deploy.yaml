name: Build & Deploy Agents

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      agent:
        description: "Specific agent to build (leave empty to auto-detect), or 'all'"
        required: false
        type: string

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  # Internal Gitea service for Kaniko push (HTTP, no TLS issues)
  REGISTRY: gitea-http.gitea-system.svc.cluster.local:3000
  ORG: jaybrto
  IMAGE_PREFIX: mesh-six

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      agents: ${{ steps.filter.outputs.agents }}
      core-changed: ${{ steps.filter.outputs.core-changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed agents
        id: filter
        run: |
          BUILDABLE_AGENTS=(
            api-coder
            architect-agent
            argocd-deployer
            claude-mqtt-bridge
            cost-tracker
            dashboard
            event-logger
            homelab-monitor
            infra-manager
            kubectl-deployer
            llm-service
            orchestrator
            project-manager
            qa-tester
            researcher-agent
            simple-agent
            ui-agent
            webhook-receiver
          )

          if [ -n "${{ inputs.agent }}" ]; then
            if [ "${{ inputs.agent }}" = "all" ]; then
              JSON=$(printf '%s\n' "${BUILDABLE_AGENTS[@]}" | jq -R . | jq -sc .)
              echo "agents=$JSON" >> "$GITHUB_OUTPUT"
            else
              echo 'agents=["${{ inputs.agent }}"]' >> "$GITHUB_OUTPUT"
            fi
            echo "core-changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          CORE_CHANGED=false
          if echo "$CHANGED_FILES" | grep -q '^packages/core/'; then
            CORE_CHANGED=true
          fi
          echo "core-changed=$CORE_CHANGED" >> "$GITHUB_OUTPUT"

          AGENTS=()

          for agent in "${BUILDABLE_AGENTS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^apps/${agent}/"; then
              AGENTS+=("$agent")
            fi
          done

          # If core changed, rebuild all agents
          if [ "$CORE_CHANGED" = "true" ]; then
            AGENTS=("${BUILDABLE_AGENTS[@]}")
          fi

          # If Dockerfile.agent changed, rebuild all agents
          if echo "$CHANGED_FILES" | grep -q '^docker/Dockerfile.agent'; then
            AGENTS=("${BUILDABLE_AGENTS[@]}")
          fi

          # If Dockerfile.dashboard changed, add dashboard
          if echo "$CHANGED_FILES" | grep -q '^docker/Dockerfile.dashboard'; then
            AGENTS+=("dashboard")
          fi

          # If Dockerfile.llm-service changed, add llm-service
          if echo "$CHANGED_FILES" | grep -q '^docker/Dockerfile.llm-service'; then
            AGENTS+=("llm-service")
          fi

          # Deduplicate
          UNIQUE_AGENTS=($(echo "${AGENTS[@]}" | tr ' ' '\n' | sort -u))

          if [ ${#UNIQUE_AGENTS[@]} -eq 0 ]; then
            echo 'agents=[]' >> "$GITHUB_OUTPUT"
          else
            JSON=$(printf '%s\n' "${UNIQUE_AGENTS[@]}" | jq -R . | jq -sc .)
            echo "agents=$JSON" >> "$GITHUB_OUTPUT"
          fi

  core-tests:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck core
        run: cd packages/core && bun run typecheck

      - name: Test core
        run: cd packages/core && bun test

  build-push:
    needs: [detect-changes, core-tests]
    if: ${{ needs.detect-changes.outputs.agents != '[]' }}
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        agent: ${{ fromJson(needs.detect-changes.outputs.agents) }}
    steps:
      - uses: actions/checkout@v4

      - name: Get metadata
        id: meta
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> "$GITHUB_OUTPUT"
          PROXY_IP=$(kubectl get svc gitea-auth-proxy -o jsonpath='{.spec.clusterIP}')
          echo "proxy_ip=${PROXY_IP}" >> "$GITHUB_OUTPUT"

      - name: Build with Kaniko
        run: |
          DOCKERFILE="docker/Dockerfile.agent"
          if [ "${{ matrix.agent }}" = "dashboard" ]; then
            DOCKERFILE="docker/Dockerfile.dashboard"
          elif [ "${{ matrix.agent }}" = "llm-service" ]; then
            DOCKERFILE="docker/Dockerfile.llm-service"
          fi
          DEST="${{ env.REGISTRY }}/${{ env.ORG }}/${{ env.IMAGE_PREFIX }}-${{ matrix.agent }}"
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: kaniko-mesh-six-${{ matrix.agent }}-${{ github.run_id }}
            namespace: default
          spec:
            restartPolicy: Never
            hostAliases:
              - ip: "${{ steps.meta.outputs.proxy_ip }}"
                hostnames:
                  - gitea.k3s.bto.bar
            initContainers:
              - name: setup-certs
                image: alpine:latest
                command: ["sh", "-c", "cat /etc/ssl/certs/ca-certificates.crt /custom-ca/ca.crt > /certs/ca-certificates.crt"]
                volumeMounts:
                  - name: merged-certs
                    mountPath: /certs
                  - name: custom-ca
                    mountPath: /custom-ca
            containers:
              - name: kaniko
                image: gcr.io/kaniko-project/executor:latest
                env:
                  - name: SSL_CERT_FILE
                    value: /certs/ca-certificates.crt
                args:
                  - "--dockerfile=${DOCKERFILE}"
                  - "--context=git://github.com/${{ github.repository }}.git#refs/heads/${{ github.ref_name }}"
                  - "--build-arg=AGENT_APP=${{ matrix.agent }}"
                  - "--destination=${DEST}:latest"
                  - "--destination=${DEST}:${{ steps.meta.outputs.sha_short }}"
                  - "--destination=${DEST}:${{ steps.meta.outputs.timestamp }}"
                  - "--cache=true"
                  - "--cache-repo=${DEST}/cache"
                  - "--insecure-registry=${{ env.REGISTRY }}"
                volumeMounts:
                  - name: docker-config
                    mountPath: /kaniko/.docker
                  - name: merged-certs
                    mountPath: /certs
            volumes:
              - name: docker-config
                secret:
                  secretName: gitea-registry-push
                  items:
                    - key: .dockerconfigjson
                      path: config.json
              - name: custom-ca
                configMap:
                  name: gitea-proxy-ca
              - name: merged-certs
                emptyDir: {}
          EOF

      - name: Wait for build
        run: |
          POD_NAME="kaniko-mesh-six-${{ matrix.agent }}-${{ github.run_id }}"
          echo "Waiting for ${{ matrix.agent }} build..."
          kubectl wait --for=condition=Ready "pod/${POD_NAME}" --timeout=120s 2>/dev/null || true
          while true; do
            STATUS=$(kubectl get pod "${POD_NAME}" -o jsonpath='{.status.phase}')
            echo "Build status: $STATUS"
            if [ "$STATUS" = "Succeeded" ]; then
              echo "Build completed successfully!"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "Build failed!"
              kubectl logs "${POD_NAME}"
              exit 1
            fi
            sleep 10
          done

      - name: Show build logs
        if: always()
        run: kubectl logs "kaniko-mesh-six-${{ matrix.agent }}-${{ github.run_id }}" 2>/dev/null || true

      - name: Cleanup
        if: always()
        run: kubectl delete pod "kaniko-mesh-six-${{ matrix.agent }}-${{ github.run_id }}" --ignore-not-found

  deploy:
    needs: [detect-changes, build-push]
    if: always() && !failure() && !cancelled() && needs.detect-changes.outputs.agents != '[]'
    runs-on: self-hosted
    steps:
      - name: Restart updated deployments
        run: |
          AGENTS='${{ needs.detect-changes.outputs.agents }}'
          for agent in $(echo "$AGENTS" | jq -r '.[]'); do
            echo "Restarting ${agent}..."
            kubectl -n mesh-six rollout restart "deployment/${agent}" 2>/dev/null || true
            kubectl -n mesh-six rollout status "deployment/${agent}" --timeout=120s 2>/dev/null || true
          done
