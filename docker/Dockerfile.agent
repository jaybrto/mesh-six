# syntax=docker/dockerfile:1

FROM oven/bun:1.2 AS builder

WORKDIR /app

# Copy package files
COPY package.json bunfig.toml ./
COPY packages/core/package.json ./packages/core/
ARG AGENT_APP=simple-agent
COPY apps/${AGENT_APP}/package.json ./apps/${AGENT_APP}/

# Install dependencies
RUN bun install --frozen-lockfile

# Copy source
COPY tsconfig.json ./
COPY packages/core/ ./packages/core/
COPY apps/${AGENT_APP}/ ./apps/${AGENT_APP}/

# Build the agent
RUN bun build apps/${AGENT_APP}/src/index.ts \
    --target=bun \
    --outdir=dist \
    --minify

# --- Runtime ---
FROM oven/bun:1.2-slim

WORKDIR /app

# Copy built output
COPY --from=builder /app/dist ./

# Run as non-root
USER bun

EXPOSE 3000

CMD ["bun", "run", "index.js"]
