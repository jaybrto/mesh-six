# syntax=docker/dockerfile:1

FROM registry.bto.bar/jaybrto/bun:1.2 AS builder

WORKDIR /app

# Copy workspace manifests first (layer cache: reinstall only when deps change)
COPY package.json bunfig.toml bun.lock* ./
COPY packages/core/package.json ./packages/core/
ARG AGENT_APP=simple-agent
COPY apps/${AGENT_APP}/package.json ./apps/${AGENT_APP}/

# --frozen-lockfile fails when partial workspace (only core + agent) is copied;
# bun.lock references all 17 workspace packages. Use bun install without it.
RUN bun install

# Copy source
COPY tsconfig.json ./
COPY packages/core/ ./packages/core/
COPY apps/${AGENT_APP}/ ./apps/${AGENT_APP}/

# --- Runtime ---
FROM registry.bto.bar/jaybrto/bun:1.2-slim

WORKDIR /app

# Copy installed deps + source (run from source to avoid bundler issues with native packages)
COPY --from=builder /app .

# Bake the entrypoint path into the image at build time
ARG AGENT_APP=simple-agent
ENV AGENT_ENTRY="apps/${AGENT_APP}/src/index.ts"

# Run as non-root
USER bun

EXPOSE 3000

CMD ["sh", "-c", "bun run ${AGENT_ENTRY}"]
